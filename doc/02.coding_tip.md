개발:computer::smiling_imp::computer:
---------------------------

여러 프로젝트가 개발을 진행하므로, 개발 진행 시 tip이나 코드 규약 등을 정해서 사용합니다.

* [모듈 구조](#모듈-구조)  
* [API interface to index](#API-interface-to-index)  
* [API interface to controller](#API-interface-to-controller)  
* [Token](#Token)

### 모듈 구조
---------------------------
![proxt_setting](./img/img_005.PNG)

* `index.js` : 호출 주소와 방식(get,post,put,delete)에 따라 해당하는 컨트롤러를 연결
* `tokenF.controller.js` : Token 인증, Refresh token 생성, 로그아웃 시 redis에서 Delete 하는 기능을 제공 

<br/>
<br/>

### API interface to index
---------------------------

<p float="left">
  <img src="./img/img_006.PNG" width="1035" height="277"/>   
</p>

- Front에서 토큰 생성을 위해 backend를 호출하게 되면 `app.js`를 통해 각 controller를 찾아가 동작을 수행하게 된다.   

- `localhost:8080/tokenF`라는 주소로 요청이 들어올경우 동작하며, 
호출되면 `./api/interface/tokenF`의 폴더를 찾아가 `index.js`파일을 가장 먼저 찾는다.  
- `index.js` 내 정의 된 호출 주소와 방식(get,post,put,delete)에 따라 해당하는 컨트롤러를 찾아간다.  

**예시) token 생성**
- `localhost:8080/tokenF/create` (post) 방식으로 호출 할 경우 `controller.createToken`을 호출   
<br/>
<br/>

### API interface to controller
---------------------------
**예시) token 생성**
<p float="left">
  <img src="./img/img_007.png" width="1015" height="652"/>   
</p>

Index에서 `controller.createToken`를 호출 할 경우 `createToken`함수가 호출된다.  

- request body에서 전달한 userId, userType을 전달 받으며, 두 타입이 존재하지 않으면 400 Error를 발생하여 처리한다.
- Token 생성 시 필요한 payload에 request body로 전달한 두 개의 값을 저장한다.
- `.env`의 JWT_SECRET 값을 지정하여 JWT 비밀키를 저장한다.
- `.env`의 tokenEffectiveTime을 통해 토큰 유효기간을 2시간으로 설정한다. (기본값: 2시간)

JWT Sign을 통해 위에서 저장한 값들을 통해 Token을 생성한다.
마지막으로 토큰을 redis에 저장하고 리턴한다. (White List 방식을 통해 토큰을 관리)

<br/>
<br/>

### Token
---------------------------

`토큰발급`
<p float="left">
  <img src="./img/tokenCreateR.png" width="450" height="500"/>  
</p>

Login시 위의 그림처럼 토큰서버에 토큰 발급을 요청하여 새로운 토큰을 발급하고 화면에 넘겨주면 해당 토큰을 통해 인증과 로그인 상태유지를 할 수 잇다.  

<br/>
<br/>

`토큰갱신`
<p float="left">
  <img src="./img/tokenRefreshR.png" width="450" height="520"/>  
</p>

화면에서 backend 서버에 api 요청을 할 경우 위의 그림처럼 토큰서버에 토큰 refresh를 요청 한 후 새롭게 발급된 토큰을 화면에 넘겨준다. 해당 동작은 로그인이 필요한 화면의 기능일 경우에 수행된다.  

<br/>
<br/>

`index에서의 refresh 함수 `
<p float="left">
  <img src="./img/indexRefresh.png" width="450" height="520"/>  
</p>

위의 그림은 api 호출이 들어왔을때, 해당 함수를 실행하기 전 token refresh를 수행하여 token을 갱신해주는 모습이다.
refresh 함수를 보면 마지막에 next()가 선언이 되어있기때문에 위의 그림에서 `,`를 통해 연결을 해주면 refresh 로직이 수행 된 후 기존의 로직을 수행한다.

<br/>
<br/>

`토큰삭제`
<p float="left">
  <img src="./img/tokenDeleteR.png" width="450" height="520"/>  
</p>

Logout시 위의 그림처럼 토큰서버에 토큰 삭제를 요청하여 로그아웃을 진행한다.  

<br/>
<br/>

`토큰 공통함수(발급,삭제)`
<p float="left">
  <img src="./img/tokenCdCommon.png" width="450" height="520"/>  
</p>

토큰 발급과 토큰 삭제시 토큰서버를 호출하는 공통함수이다. 위의 1번과 3번 동작수행시 해당 함수를 호출한다.  

<br/>
<br/>

`토큰 공통함수(갱신)`
<p float="left">
  <img src="./img/tokenReCommon.png" width="450" height="520"/>  
</p>

토큰 갱신시 토큰서버를 호출하는 공통함수이다. 위의 2번 동작수행시 해당함수를 호출한다.  

